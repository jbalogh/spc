<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>South Park Cafe Wine Menu</title>
    <script src="https://unpkg.com/d3@5.9.2/dist/d3.js" crossorigin></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Raleway:300,300i,300b&display=swap" rel="stylesheet">

<style>
#wine-list {
  font-family: 'Raleway', sans-serif;
  width: 1040px;
  font-size: 16px;
  margin: 0 auto;
}
.styles {
  display: grid;
  grid-template-columns: 500px 500px;
  grid-column-gap: 40px;
  page-break-inside: avoid;
}
.btg {
  margin: 10px 0;
  line-height: 18px;
}
.row {
  display: grid;
  grid-template-columns: 3fr 3fr 70px;
}
.price {
  text-align: right;
}
.row + .row {
  font-size: 70%;
}
.title {
  font-style: italic;
}
.grape {
  font-size: 90%;
  font-weight: bold;
}
#cocktails {
  columns: 2;
}
#cocktails .btg {
  break-inside: avoid;
}
.style {
  page-break-inside: avoid;
}
</style>
  </head>
  <body>
    <div id="wine-list">
      <div id="wines"></div>
      <div id="drinks"</div>
    </div>
<script type="text/babel">

function process(data) {
  data.forEach((w, idx) => {
    w.btg = w['BTG'] != '';
    w.isSpirit = w['Type'].startsWith('Spirits:');
    if (w.isSpirit) w['Type'] = w['Type'].slice(9);
    w.bottle = w['Bottle'] != '';
    w.order = +(w.btg ? w['BTG'] : w['Bottle']);
    w.key = idx;
  });
  const ws = data.filter(d => d.btg || d.bottle);
  const rv = {
    all: ws,
    white: ws.filter(d => d.Type == 'White'),
    red: ws.filter(d => d.Type == 'Red'),
    bubbles: ws.filter(d => d.Type == 'Bubbles'),
    rose: ws.filter(d => d.Type == 'Rosé'),
    cider: ws.filter(d => d.Type == 'Cider'),
    dessert: ws.filter(d => d.Type == 'Dessert'),
    spirits: ws.filter(d => d.isSpirit),
  };
  function cmp(a, b) {
    if (a.btg && b.btg || a.bottle && b.bottle) return a.order - b.order;
    else if (a.btg && !b.btg) return -1;
    else if (!a.btg && b.btg) return 1;
    else return 0;
  }
  Object.values(rv).forEach(arr => arr.sort(cmp));
  return rv;
}
    
class WineList extends React.Component {
  render() {
    const data = process(this.props.data);
    window.datums = data;
    const btg = [
      ['Bubbles', data.bubbles],
      ['Rosé', data.rose],
      ['White', data.white],
      ['Red', data.red],
      ['Dessert Wines', data.dessert],
      ['Ciders', data.cider],
      ['Spirits', data.spirits],
    ];
    return (
      <div className="styles">
        {btg.map(([title, wines]) => {
          return (
            <div className="style" key={title}>
              <h2>{title}</h2>
              <div>{wines.map(w => <Drink key={w.key} wine={w} />)}</div>
            </div>
          );
         })}
      </div>
    );
  }
}

function loc(w) {
  if (w['Country'] == 'USA') return [w['Place'], w['Region']];
  else if (w['Region'] == 'Burgundy') return [w['Place'], w['Region'], w['Country']];
  else return [w['Region'], w['Country']];
}

function priceLabel(w) {
  const price = Math.round(w['Price']);
  if (w.Type == 'Dessert') return '$' + price;
  else if (w.Type == 'Cider') return '$' + Math.floor(1.5 * price);
  else if (w.isSpirit) return '$' + Math.floor(price / 12 * 2.5);
  else if (w.btg) return '$' + price + '/$' + Math.floor(price * 3.2);
  else return '$' + Math.floor(priceCalculator(price));
}

class Drink extends React.Component {
  render() {
    const w = this.props.wine;
    const place = loc(w).filter(x => x.length > 0).join(', ');
    return (
      <div className="btg">
        <div className="row">
          <span className="grape">{w.isSpirit ? w['Type'] : w['Grape']}</span>
          <span className="producer">{w['Producer']}</span>
          <span className="price">{priceLabel(w)}</span>
        </div>
        <div className="row">
          <span className="place">{place} {w['Vintage']}</span>
          <span className="title">{w['Title']}</span>
        </div>
      </div>
    );
  }
}

function processDrinks(data) {
  const xs = data.filter(x => x['Position'] != '').sort((a, b) => +a['Position'] - +b['Position']);
  return {cocktails: xs};
}

class DrinksList extends React.Component {
  render() {
    const data = processDrinks(this.props.data);
    return (
      <div>
        <h2>Cocktails <small style={{fontSize: '16px'}}>(All $14)</small></h2>
	<div id="cocktails">
	  {data.cocktails.map(x => <Cocktail drink={x} key={x['Position']} />)}
	</div>
      </div>
    );
  }
}

class Cocktail extends React.Component {
  render() {
    const w = this.props.drink;
    return (
      <div className="btg">
        <div className="row">
	  <span className="grape">{w['Name']}</span>
	</div>
        <div className="row">
	  <span className="place">{w['Ingredients']}</span>
	</div>
      </div>
    );
  }
}

function priceCalculator(x) {
  const log = Math.log;
  return Math.floor(2 * x + (x * log(10)/log(x)));
}
</script>



    <script type="text/babel">
const wineURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2ZddImze-Iwtwlj8MXMETVo9aMr4Ohjer8h4rwf70guc1mFArkIWYqcfgU_V-5ZmZWJb3LkdUsJSB/pub?gid=0&single=true&output=csv';
const cocktailsURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2ZddImze-Iwtwlj8MXMETVo9aMr4Ohjer8h4rwf70guc1mFArkIWYqcfgU_V-5ZmZWJb3LkdUsJSB/pub?gid=988098023&single=true&output=csv';
d3.csv(wineURL).then(function(data) {
  ReactDOM.render(<WineList data={data} />, document.getElementById('wines'));
});

d3.csv(cocktailsURL).then(function(data) {
  ReactDOM.render(<DrinksList data={data} />, document.getElementById('drinks'));
});

function acc(key, ws) { 
  return ws.reduce((accum, w) => { 
    const t = w[key]; 
    if (accum[t]) accum[t] += 1; 
    else accum[t] = 1; 
    return accum;
   }, 
   {}
  );
}
    </script>
  </body>
</html>
