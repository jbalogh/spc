<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/d3@5.9.2/dist/d3.js" crossorigin></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Raleway:300,300i,300b&display=swap" rel="stylesheet">

<style>
#wine-list {
  font-family: 'Raleway', sans-serif;
  width: 1040px;
  font-size: 16px;
  margin: 0 auto;
}
.styles {
  display: grid;
  grid-template-columns: 500px 500px;
  grid-column-gap: 40px;
}
.btg {
  margin: 10px 0;
  line-height: 18px;
}
.row {
  display: grid;
  grid-template-columns: 3fr 3fr 70px;
}
.price {
  text-align: right;
}
.row + .row {
  font-size: 70%;
}
.title {
  font-style: italic;
}
.grape {
  font-size: 90%;
  font-weight: bold;
}
</style>
  </head>
  <body>
    <div id="wine-list">
      <div id="wines"></div>
    </div>
<script type="text/babel">

function process(data) {
  data.forEach(w => {
    w.btg = w['BTG'] != '';
    w.bottle = w['Bottle'] != '';
    w.order = +(w.btg ? w['BTG'] : w['Bottle']);
  });
  const ws = data.filter(d => d.btg || d.bottle);
  const rv = {
    all: ws,
    whiteBTG: ws.filter(d => d.Type == 'White'),
    redBTG: ws.filter(d => d.Type == 'Red'),
    bubblesBTG: ws.filter(d => d.Type == 'Bubbles'),
    roseBTG: ws.filter(d => d.Type == 'Rosé'),
  }
  function cmp(a, b) {
    if (a.btg && b.btg || a.bottle && b.bottle) return a.order - b.order;
    else if (a.btg && !b.btg) return -1;
    else if (!a.btg && b.btg) return 1;
    else return 0;
  }
  Object.values(rv).forEach(arr => arr.sort(cmp));
  return rv;
}
    
class WineList extends React.Component {
  render() {
    const data = process(this.props.data);
    window.datums = data;
    const btg = [
      ['Bubbles', data.bubblesBTG],
      ['Rosé', data.roseBTG],
      ['White', data.whiteBTG],
      ['Red', data.redBTG],
    ];
    return (
      <div className="styles">
        {btg.map(([title, wines]) => {
          return (
            <div key={title}>
              <h2>{title}</h2>
              <div>{wines.map(w => <BTG key={w['Producer'] + w['Title']} wine={w} />)}</div>
            </div>
          );
         })}
      </div>
    );
  }
}

function loc(w) {
  if (w['Country'] == 'USA') return [w['Place'], w['Region']];
  else if (w['Region'] == 'Burgundy') return [w['Place'], w['Region'], w['Country']];
  else return [w['Region'], w['Country']];
}

class BTG extends React.Component {
  render() {
    const w = this.props.wine;
    const place = loc(w).filter(x => x.length > 0).join(', ');
    const price = Math.round(w['Price']);
    const priceLabel = w.btg ? '$' + price + '/$' + Math.floor(price * 3.5) : '$' + Math.floor(price * 3);
    return (
      <div className="btg">
        <div className="row">
          <span className="grape">{w['Grape']}</span>
          <span className="producer">{w['Producer']}</span>
          <span className="price">{priceLabel}</span>
        </div>
        <div className="row">
          <span className="place">{place} {w['Vintage']}</span>
          <span className="title">{w['Title']}</span>
        </div>
      </div>
    );
  }
}
</script>



    <script type="text/babel">
const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2ZddImze-Iwtwlj8MXMETVo9aMr4Ohjer8h4rwf70guc1mFArkIWYqcfgU_V-5ZmZWJb3LkdUsJSB/pub?gid=0&single=true&output=csv'
d3.csv(url).then(function(data) {
  ReactDOM.render(<WineList data={data} />, document.getElementById('wines'));
});
function acc(key, ws) { 
  return ws.reduce((accum, w) => { 
    const t = w[key]; 
    if (accum[t]) accum[t] += 1; 
    else accum[t] = 1; 
    return accum;
   }, 
   {}
  );
}
    </script>
  </body>
</html>
